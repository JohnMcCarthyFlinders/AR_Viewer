<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quest MR GLB Viewer (WebXR)</title>
  <!-- Model Viewer web component -->
<script>
  const mv = document.getElementById('mv');
  const input = document.getElementById('src');
  const loadBtn = document.getElementById('load');
  const enterBtn = document.getElementById('enterAr');
  const status = document.getElementById('status');
  const support = document.getElementById('support');

  // Helper: add ?v=<timestamp> for same-origin GLBs to defeat stale caches
  const bust = (raw) => {
    try {
      const abs = new URL(raw, location.href);        // resolve relative like models/C.glb
      if (abs.origin === location.origin) {
        abs.searchParams.set('v', Date.now().toString());
      }
      return abs.href;
    } catch { return raw; }
  };

  // Load from ?src=<...>
  try {
    const p = new URL(location.href).searchParams.get('src');
    if (p) { mv.src = bust(p); input.value = p; status.textContent = 'Loading…'; }
  } catch {}

  // AR support indicator
  const refreshSupport = () => {
    const can = mv.canActivateAR;
    support.textContent = `AR support: ${can ? 'available' : 'unavailable'} (mode: webxr)`;
    enterBtn.disabled = !can;
    enterBtn.title = can ? 'Enter passthrough' : 'AR not available in this browser or context';
  };

  mv.addEventListener('load', () => { status.textContent = `Loaded: ${mv.src}`; });
  mv.addEventListener('error', (e) => {
    status.innerHTML = `<span class="error">Error: ${e.detail?.message || 'failed to load model'}</span>`;
  });
  mv.addEventListener('ar-status', (e) => {
    if (e.detail.status === 'failed') {
      status.innerHTML = '<span class="error">AR failed to start. Ensure HTTPS and Quest Browser, then try again.</span>';
    }
  });

  // Load button
  loadBtn.addEventListener('click', async () => {
    const raw = input.value.trim();
    if (!raw) return;
    const url = bust(raw);
    mv.src = url;
    status.textContent = 'Loading…';
  });

  // Enter AR
  enterBtn.addEventListener('click', async () => {
    try {
      if (!mv.canActivateAR) {
        status.innerHTML = '<span class="error">AR not available. Use Quest Browser over HTTPS.</span>';
        return;
      }
      await mv.activateAR();
    } catch (err) {
      status.innerHTML = `<span class="error">AR error: ${err?.message || err}</span>`;
    }
  });

  refreshSupport();
  setTimeout(refreshSupport, 1000);
</script>

</body>
</html>
